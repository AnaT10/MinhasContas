<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ContaF√°cil - Gest√£o Inteligente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-color: #4361ee;
            --bg-body: #f4f7fe;
            --card-bg: #ffffff;
            --text-main: #2b3674;
            --text-muted: #a3aed0;
            --sidebar-bg: #ffffff;
            --radius: 20px;
            --success-color: #05cd99;
            --danger-color: #ee5d50;
            --warning-color: #ffb800;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
        }

        .sidebar {
            height: 100vh;
            width: 280px;
            position: fixed;
            top: 0;
            left: -280px;
            background: var(--sidebar-bg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            padding: 2rem 1.5rem;
            box-shadow: 10px 0 30px rgba(0,0,0,0.03);
        }
        .sidebar.active { left: 0; }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(4px);
            display: none; z-index: 1090;
        }
        .sidebar-overlay.active { display: block; }

        .sidebar .nav-link {
            display: flex; align-items: center;
            padding: 12px 18px; color: var(--text-muted);
            border-radius: 12px; margin-bottom: 8px;
            font-weight: 600; transition: all 0.3s;
            text-decoration: none; cursor: pointer;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: var(--primary-color); color: #fff;
        }

        .main-content { padding: 2rem; transition: margin-left 0.4s; }
        .card {
            background: var(--card-bg); border: none;
            border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.04);
            padding: 1.5rem; margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem; font-weight: 700;
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;
        }
        .section-title::before {
            content: ''; width: 4px; height: 20px;
            background: var(--primary-color); border-radius: 10px;
        }

        .summary-card {
            border-radius: var(--radius); padding: 24px;
            color: #fff; position: relative; overflow: hidden; height: 100%;
            transition: transform 0.3s;
        }
        .summary-card:hover { transform: translateY(-5px); }
        .summary-positive { background: linear-gradient(135deg, #05cd99 0%, #00b386 100%); }
        .summary-negative { background: linear-gradient(135deg, #ee5d50 0%, #e31a1a 100%); }
        .summary-neutral { background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); }

        .menu-toggle {
            background: #fff; border: none; width: 45px; height: 45px;
            border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .list-group-item {
            background: #fcfdfe; border: 1px solid #f1f5f9;
            border-radius: 16px !important; margin-bottom: 12px; padding: 16px;
            transition: transform 0.2s;
        }
        .progress { height: 10px; border-radius: 10px; background-color: #f1f5f9; }
        
        /* Home Specific Styles */
        .stat-icon {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin-bottom: 1rem;
        }
        .bg-soft-primary { background: #eef2ff; color: var(--primary-color); }
        .bg-soft-success { background: #e6fcf5; color: var(--success-color); }
        .bg-soft-danger { background: #fff5f5; color: var(--danger-color); }
        .bg-soft-warning { background: #fff9db; color: var(--warning-color); }

        .somatorio-item {
            padding: 12px; border-radius: 12px; background: #f8fafc;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar" class="sidebar">
        <div class="d-flex align-items-center mb-5">
            <div class="bg-primary text-white rounded-3 p-2 me-3">
                <i class="bi bi-wallet2 h4 mb-0"></i>
            </div>
            <h3 class="fw-bold mb-0">ContaF√°cil</h3>
        </div>
        
        <nav>
            <div onclick="switchTab('home', this)" class="nav-link active">
                <i class="bi bi-house-door-fill me-2"></i> In√≠cio
            </div>
            <div onclick="switchTab('dashboard', this)" class="nav-link">
                <i class="bi bi-plus-circle-fill me-2"></i> Lan√ßamentos
            </div>
            <div onclick="switchTab('insights', this)" class="nav-link">
                <i class="bi bi-lightning-charge-fill me-2"></i> Insights e Metas
            </div>
            <div onclick="switchTab('relatorios', this)" class="nav-link">
                <i class="bi bi-pie-chart-fill me-2"></i> Relat√≥rios
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <i class="bi bi-list h4 mb-0"></i>
            </button>
            <div class="month-navigation bg-white px-3 py-2 rounded-pill shadow-sm d-flex align-items-center">
                <button class="btn btn-sm btn-link text-decoration-none" onclick="changeFilterMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                <span id="currentMonthLabel" class="mx-2 fw-bold small text-uppercase" style="min-width: 120px; text-align: center;"></span>
                <button class="btn btn-sm btn-link text-decoration-none" onclick="changeFilterMonth(1)"><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>

        <!-- Se√ß√£o Home -->
        <div id="home" class="content-section">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card h-100 text-center">
                        <div class="stat-icon bg-soft-primary mx-auto"><i class="bi bi-cash-stack"></i></div>
                        <small class="text-muted fw-bold">ECONOMIA</small>
                        <h3 class="fw-bold mt-1" id="homeEconomia">R$ 0,00</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100 text-center">
                        <div class="stat-icon bg-soft-warning mx-auto"><i class="bi bi-exclamation-triangle"></i></div>
                        <small class="text-muted fw-bold">ALERTAS</small>
                        <h3 class="fw-bold mt-1" id="homeAlertas">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100 text-center">
                        <div class="stat-icon bg-soft-success mx-auto"><i class="bi bi-graph-up-arrow"></i></div>
                        <small class="text-muted fw-bold">PROJE√á√ÉO</small>
                        <h3 class="fw-bold mt-1" id="homeProjecao">R$ 0,00</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100 text-center">
                        <div class="stat-icon bg-soft-danger mx-auto"><i class="bi bi-star"></i></div>
                        <small class="text-muted fw-bold">MAIOR CATEGORIA</small>
                        <h3 class="fw-bold mt-1 text-truncate" id="homeMaiorCat" style="font-size: 1.1rem;">---</h3>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <h4 class="section-title">An√°lise de Sa√∫de</h4>
                        <div class="d-flex align-items-center mb-4 p-3 rounded-4" id="saudeFinanceiraCard" style="background: #f8fafc;">
                            <div class="me-4 text-center">
                                <div id="saudeEmoji" style="font-size: 2.5rem;">üòê</div>
                                <div class="fw-bold small" id="saudeStatus">Est√°vel</div>
                            </div>
                            <div>
                                <p class="mb-0 small text-muted" id="saudeFeedback">Carregando an√°lise...</p>
                            </div>
                        </div>

                        <h5 class="fw-bold mb-3 small text-muted">SOMAT√ìRIOS POR CATEGORIA (DESPESAS)</h5>
                        <div id="homeSomatoriosList">
                            <!-- Injetado via JS -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card h-100">
                        <h4 class="section-title">Distribui√ß√£o</h4>
                        <canvas id="homeChartCategorias" style="max-height: 200px;"></canvas>
                        
                        <div class="mt-4 pt-3 border-top">
                            <div class="d-flex justify-content-between mb-2 small">
                                <span>Receitas Totais</span>
                                <b class="text-success" id="homeTotalReceitas">R$ 0,00</b>
                            </div>
                            <div class="d-flex justify-content-between mb-2 small">
                                <span>Despesas Totais</span>
                                <b class="text-danger" id="homeTotalDespesas">R$ 0,00</b>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Saldo Final</span>
                                <span id="homeTotalSaldo">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o Lan√ßamentos -->
        <div id="dashboard" class="content-section" style="display: none;">
            <div class="row g-4 mb-4" id="resumoGeral"></div>
            <div class="row">
                <div class="col-lg-4">
                    <div class="card">
                        <h4 class="section-title" id="formTitle">Novo Lan√ßamento</h4>
                        <form id="formAdicionarConta">
                            <div class="mb-3">
                                <label class="form-label small text-muted fw-bold">Tipo</label>
                                <div class="btn-group w-100">
                                    <input type="radio" class="btn-check" name="tipo" id="tipoReceita" value="Receita" onchange="populateCategories()" checked>
                                    <label class="btn btn-outline-success" for="tipoReceita">Receita</label>
                                    <input type="radio" class="btn-check" name="tipo" id="tipoDespesa" value="Despesa" onchange="populateCategories()">
                                    <label class="btn btn-outline-danger" for="tipoDespesa">Despesa</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small text-muted fw-bold">Categoria</label>
                                <select id="categoria" class="form-select" onchange="populateSubCategories()" required></select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small text-muted fw-bold">Subcategoria</label>
                                <select id="subCategoria" class="form-select" required></select>
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-white">R$</span>
                                <input type="text" id="valor" class="form-control" placeholder="0,00" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="btnRegistrar">Registrar</button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card">
                        <h4 class="section-title">Extrato do M√™s</h4>
                        <div id="listaContas" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Outras abas (Insights/Relat√≥rios) seguem a mesma l√≥gica -->
        <div id="insights" class="content-section" style="display: none;">
             <div class="card"><h4 class="section-title">Metas de Gastos</h4><div id="metasProgressoContainer"></div></div>
        </div>
        <div id="relatorios" class="content-section" style="display: none;">
             <div class="row"><div class="col-6"><canvas id="chartCategorias"></canvas></div><div class="col-6"><canvas id="chartComparativo"></canvas></div></div>
        </div>
    </div>

    <script>
        const CATEGORIES = {
            Receita: { "Trabalho": ["Sal√°rio", "Freelance"], "Investimentos": ["Dividendos"], "Outros": ["Venda"] },
            Despesa: { "Moradia": ["Aluguel", "Luz", "√Ågua"], "Supermercado": ["M√™s", "Feira"], "Sa√∫de": ["Farm√°cia"], "Outros": ["Lazer"] }
        };
        let budgets = { "Moradia": 1500, "Supermercado": 800, "Sa√∫de": 300, "Outros": 500 };
        let contas = JSON.parse(localStorage.getItem('contas_v3') || '[]');
        let currentFilterDate = new Date();
        let chartHomeCatInstance;

        window.onload = () => { populateCategories(); initFormatters(); renderAll(); };

        function switchTab(tabId, el) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if(tabId === 'home') renderHomeTab();
            if(tabId === 'relatorios') setTimeout(initCharts, 100);
            if(tabId === 'insights') renderInsightsTab();
            if(window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function renderAll() {
            const label = currentFilterDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthLabel').innerText = label;
            renderHomeTab();
            renderLista(filterDataByMonth(contas));
            renderResumo(filterDataByMonth(contas));
        }

        function filterDataByMonth(data) {
            const m = currentFilterDate.getMonth(), y = currentFilterDate.getFullYear();
            return data.filter(c => { const d = new Date(c.data); return d.getMonth() === m && d.getFullYear() === y; });
        }

        function renderHomeTab() {
            const filtered = filterDataByMonth(contas);
            const rec = filtered.filter(c => c.tipo === 'Receita').reduce((a,b) => a+b.valor,0);
            const desp = filtered.filter(c => c.tipo === 'Despesa').reduce((a,b) => a+b.valor,0);
            const saldo = rec - desp;

            // Somat√≥rios por Categoria
            const catTotals = {};
            filtered.filter(c => c.tipo === 'Despesa').forEach(d => {
                catTotals[d.categoria] = (catTotals[d.categoria] || 0) + d.valor;
            });

            const somatoriosContainer = document.getElementById('homeSomatoriosList');
            somatoriosContainer.innerHTML = '';
            
            const sortedCats = Object.entries(catTotals).sort((a,b) => b[1] - a[1]);
            
            if (sortedCats.length === 0) {
                somatoriosContainer.innerHTML = '<p class="text-muted small">Nenhuma despesa registada este m√™s.</p>';
            } else {
                sortedCats.forEach(([cat, val]) => {
                    const perc = (val / (desp || 1) * 100).toFixed(0);
                    somatoriosContainer.innerHTML += `
                        <div class="somatorio-item">
                            <div>
                                <span class="fw-bold">${cat}</span>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">Representa ${perc}% do total</small>
                            </div>
                            <b class="text-danger">${toBRL(val)}</b>
                        </div>
                    `;
                });
            }

            // Cards Superiores
            document.getElementById('homeEconomia').innerText = toBRL(Math.max(0, saldo));
            document.getElementById('homeProjecao').innerText = toBRL(saldo);
            document.getElementById('homeMaiorCat').innerText = sortedCats[0] ? sortedCats[0][0] : "---";

            // Painel Lateral
            document.getElementById('homeTotalReceitas').innerText = toBRL(rec);
            document.getElementById('homeTotalDespesas').innerText = toBRL(desp);
            const saldoEl = document.getElementById('homeTotalSaldo');
            saldoEl.innerText = toBRL(saldo);
            saldoEl.className = saldo >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger';

            // Sa√∫de Financeira
            const emoji = document.getElementById('saudeEmoji'), status = document.getElementById('saudeStatus'), feedback = document.getElementById('saudeFeedback');
            if (saldo < 0) { emoji.innerText="üòü"; status.innerText="Cr√≠tico"; feedback.innerText="As suas despesas superaram as receitas. Verifique a sua categoria mais alta."; }
            else if (rec > 0 && saldo < rec * 0.1) { emoji.innerText="üòê"; status.innerText="Aten√ß√£o"; feedback.innerText="Est√° a poupar pouco. Tente reduzir gastos em categorias n√£o essenciais."; }
            else if (rec > 0) { emoji.innerText="üòä"; status.innerText="Saud√°vel"; feedback.innerText="Excelente gest√£o! O seu saldo est√° positivo e dentro de uma margem segura."; }
            else { emoji.innerText="üò∂"; status.innerText="Sem Dados"; feedback.innerText="Inicie os lan√ßamentos do m√™s para ver a an√°lise."; }

            // Gr√°fico
            if(chartHomeCatInstance) chartHomeCatInstance.destroy();
            chartHomeCatInstance = new Chart(document.getElementById('homeChartCategorias'), {
                type: 'doughnut',
                data: { labels: Object.keys(catTotals), datasets: [{ data: Object.values(catTotals), backgroundColor: ['#4361ee','#4cc9f0','#05cd99','#ee5d50','#ffb800'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } } }
            });
        }

        // Fun√ß√µes Auxiliares
        function toBRL(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        
        function populateCategories() {
            const t = document.querySelector('input[name="tipo"]:checked').value;
            const s = document.getElementById('categoria'); s.innerHTML = '';
            Object.keys(CATEGORIES[t]).forEach(c => s.add(new Option(c, c)));
            populateSubCategories();
        }

        function populateSubCategories() {
            const t = document.querySelector('input[name="tipo"]:checked').value, c = document.getElementById('categoria').value;
            const s = document.getElementById('subCategoria'); s.innerHTML = '';
            CATEGORIES[t][c].forEach(sub => s.add(new Option(sub, sub)));
        }

        function initFormatters() {
            document.getElementById('valor').oninput = (e) => {
                let v = e.target.value.replace(/\D/g, '');
                v = (v / 100).toFixed(2).replace(".", ",");
                e.target.value = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            };
        }

        document.getElementById('formAdicionarConta').onsubmit = (e) => {
            e.preventDefault();
            const val = parseFloat(document.getElementById('valor').value.replace(/\./g, '').replace(',', '.'));
            contas.push({ id: Date.now(), tipo: document.querySelector('input[name="tipo"]:checked').value, 
            categoria: document.getElementById('categoria').value, subCategoria: document.getElementById('subCategoria').value, 
            valor: val, data: new Date(currentFilterDate).toISOString() });
            localStorage.setItem('contas_v3', JSON.stringify(contas));
            document.getElementById('formAdicionarConta').reset();
            renderAll();
        };

        function renderLista(data) {
            const l = document.getElementById('listaContas'); l.innerHTML = data.length ? '' : '<p class="text-center py-4">Sem dados.</p>';
            data.forEach(c => {
                l.innerHTML += `<div class="list-group-item d-flex justify-content-between">
                    <div><b>${c.subCategoria}</b><br><small>${c.categoria}</small></div>
                    <b class="${c.tipo==='Receita'?'text-success':'text-danger'}">${toBRL(c.valor)}</b>
                </div>`;
            });
        }

        function renderResumo(f) {
            const r = f.filter(c=>c.tipo==='Receita').reduce((a,b)=>a+b.valor,0), d = f.filter(c=>c.tipo==='Despesa').reduce((a,b)=>a+b.valor,0);
            document.getElementById('resumoGeral').innerHTML = `
                <div class="col-4"><div class="summary-card summary-neutral"><small>RECEITAS</small><h3>${toBRL(r)}</h3></div></div>
                <div class="col-4"><div class="summary-card summary-negative"><small>DESPESAS</small><h3>${toBRL(d)}</h3></div></div>
                <div class="col-4"><div class="summary-card ${r-d>=0?'summary-positive':'summary-negative'}"><small>SALDO</small><h3>${toBRL(r-d)}</h3></div></div>`;
        }

        function changeFilterMonth(o) { currentFilterDate.setMonth(currentFilterDate.getMonth()+o); renderAll(); }
    </script>
</body>
</html>
